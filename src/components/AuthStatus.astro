---
const session = Astro.locals.session;
---

<div class="flex items-center gap-2">
  {
    session?.user ? (
      <div class="flex items-center gap-3">
        <div class="relative group">
          <button class="flex items-center focus:outline-none" aria-haspopup="true">
            {session.user.image && (
              <img
                src={session.user.image}
                alt={session.user.name || 'User avatar'}
                class="w-8 h-8 rounded-full cursor-pointer"
              />
            )}
          </button>
          <div class="absolute right-0 top-full pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
            <div class="bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 w-48 border border-gray-200 dark:border-gray-700">
              <a
                href="/profile"
                class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
              >
                Your Profile
              </a>
              <a
                href="/dashboard/"
                class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
              >
                Dashboard
              </a>
              <div class="border-t border-gray-200 dark:border-gray-700 my-1" />
              <button
                type="button"
                id="signout-btn"
                class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-0 bg-transparent"
              >
                Sign out
              </button>
            </div>
          </div>
        </div>
        <span class="text-gray-700 dark:text-gray-300">{session.user.name}</span>
      </div>
    ) : (
      <a
        href="/auth/signin"
        class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400"
      >
        Sign in
      </a>
    )
  }
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const signoutBtn = document.getElementById('signout-btn');
    if (signoutBtn) {
      signoutBtn.addEventListener('click', async () => {
        try {
          await fetch('/api/signout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });
          // Redirect to home page after sign out
          window.location.href = '/';
        } catch (error) {
          console.error('Sign-out error:', error);
          // Still redirect even if there's an error
          window.location.href = '/';
        }
      });
    }
  });
</script>

<style>
  /* Add a small delay to the dropdown to make it more user-friendly */
  .group:hover > div {
    transition-delay: 100ms;
  }

  /* Ensure the dropdown stays visible when hovering over it */
  .group > div:hover {
    opacity: 100;
    visibility: visible;
  }
</style>
